#!/usr/bin/env node

var Stream = require('../lib/stream').Stream;
var fs = require('fs');
var logmagic = require('logmagic');
var log = logmagic.local('agent');
var uuid = require('node-uuid');

logmagic.route('__root__', logmagic.DEBUG, 'console');


function main() {
  // Parse Credentials
  var creds;
  try {
    creds = JSON.parse(fs.readFileSync('creds.json'));
  } catch (err) {
    log.error('Failed to load config', {'err': err.toString()});
    process.exit(1);
  }
  // Setup Options

  var options = {
    endpoints: [
      '_monitoringagent._tcp.dfw1.prod.monitoring.api.rackspacecloud.com',
      '_monitoringagent._tcp.ord1.prod.monitoring.api.rackspacecloud.com',
      '_monitoringagent._tcp.lon3.prod.monitoring.api.rackspacecloud.com'
    ],
    ca: [ fs.readFileSync('maas.cert') ],
    token: creds.token,
    agent_id: creds.agent_id,
    guid: uuid.v4(),
    process_version: '0.1.2',
    bundle_version: '0.1.2'
  };

  s = new Stream(options);
  s.connect();
}

main();
